<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
  <title>FastFinder ‚Äì Multiplayer</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    :root{ --olive:#6f7d58; --slate:#2f3a3e; --bg:#f7f9fb; --surface:#fff; --shadow:0 8px 24px rgba(0,0,0,.12) }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);font:16px/1.4 system-ui,Segoe UI,Arial}
    .desktop-only,.mobile-only{display:none}
    .app{position:fixed; inset:0; display:grid}
    .map{position:absolute; inset:0; z-index:1}
    #map{height:100vh;width:100vw}

    .app-header{position:fixed;top:0;left:0;right:0;height:64px;display:flex;align-items:center;justify-content:space-between;padding:0 16px;background:var(--surface);box-shadow:var(--shadow);z-index:10}
    .top-menu{display:flex;gap:8px}
    .btn{border:0;background:var(--olive);color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}

    .side-panel{position:fixed;top:72px;right:16px;width:380px;max-height:calc(100vh - 88px);background:var(--surface);border-radius:14px;box-shadow:var(--shadow);padding:12px;overflow:auto;z-index:9}
    .mobile-dock{position:fixed;left:0;right:0;bottom:0;height:64px;background:var(--surface);box-shadow:0 -8px 24px rgba(0,0,0,.12);display:flex;gap:6px;padding:8px;z-index:10}
    .dock-btn{flex:1;height:48px;border:0;border-radius:12px;background:var(--olive);color:#fff;font-weight:700}
    .hud{position:absolute;top:8px;left:0;right:0;display:flex;justify-content:center;gap:8px;z-index:20}
    .chip{background:rgba(255,255,255,.9);padding:6px 10px;border-radius:999px;border:1px solid rgba(0,0,0,.08)}
    .sheet{position:fixed;left:0;right:0;bottom:-65vh;height:65vh;background:var(--surface);border-top-left-radius:18px;border-top-right-radius:18px;box-shadow:0 -16px 40px rgba(0,0,0,.2);transition:bottom .25s ease;display:flex;flex-direction:column;z-index:11}
    .sheet.open{bottom:64px}
    .bottbar{position:fixed;left:0;right:0;bottom:64px;padding:8px 10px;display:flex;gap:8px;z-index:12}
    .bottbar .btn{flex:1;height:48px;border-radius:12px;border:0;background:#e9eef3;color:#20323a;font-weight:700}
    .bottbar .btn.accent{background:var(--olive);color:#fff}
    @media (min-width:980px){ .desktop-only{display:block!important} .mobile-only{display:none!important} }
    @media (max-width:979.98px){ .desktop-only{display:none!important} .mobile-only{display:flex!important} }
    #err{position:fixed;left:50%;transform:translateX(-50%);top:72px;z-index:999;background:#fee;border:1px solid #f99;color:#900;padding:8px 12px;border-radius:8px;display:none}
  </style>
</head>
<body>

<div id="err"></div>

<header class="app-header desktop-only">
  <div class="brand"><strong>FastFinder</strong></div>
  <nav class="top-menu">
    <button class="btn" onclick="openPanel('play')">Spela</button>
    <button class="btn" onclick="openPanel('rooms')">Rum</button>
    <button class="btn" onclick="openPanel('leader')">Leaderboard</button>
    <button class="btn" onclick="openPanel('about')">Om</button>
  </nav>
</header>

<main class="app">
  <div id="map" class="map"></div>

  <aside class="side-panel desktop-only" id="sidePanel">
    <h3>Spela</h3>
    <div style="margin:8px 0"><select id="selTrack" style="width:100%;height:40px"></select></div>
    <div style="display:flex;gap:8px;margin:8px 0">
      <input id="inpRounds" type="number" value="5" min="1" max="20" placeholder="Ronder" style="flex:1;height:40px;padding:0 8px">
      <input id="inpTime" type="number" value="60" min="10" max="240" placeholder="Sek/rond" style="flex:1;height:40px;padding:0 8px">
    </div>
    <div style="display:flex;gap:8px;margin:8px 0"><button class="btn" id="btnHost">Skapa rum</button></div>
    <div style="display:flex;gap:8px;margin:8px 0"><input id="inpRoom" placeholder="Rumskod" style="flex:1;height:40px;padding:0 8px"></div>
    <div style="display:flex;gap:8px;margin:8px 0">
      <input id="inpName" placeholder="Ditt namn" style="flex:1;height:40px;padding:0 8px">
      <button class="btn" id="btnJoin">G√• med</button>
    </div>
    <div style="display:flex; gap:8px">
      <button class="btn" id="btnStart" style="display:none">Starta</button>
    </div>
    <hr>
    <table id="board" style="width:100%"><thead><tr><th>Spelare</th><th>Po√§ng</th></tr></thead><tbody></tbody></table>
  </aside>

  <div class="mobile-dock mobile-only">
    <button class="dock-btn" onclick="openSheet('play')">Spela</button>
    <button class="dock-btn" onclick="openSheet('leader')">Topplista</button>
    <button class="dock-btn" onclick="openSheet('rooms')">Rum</button>
    <button class="dock-btn" onclick="openSheet('about')">Info</button>
  </div>

  <div class="hud mobile-only">
    <div class="chip">üóìÔ∏è <span id="hudRound">Rond ‚Äì</span></div>
    <div class="chip">‚è± <span id="hudTimer">‚Äì s</span></div>
    <div class="chip">‚≠ê <span id="hudScore">0 p</span></div>
  </div>

  <section class="sheet mobile-only" id="mSheet">
    <div style="padding:10px 12px">
      <div style="margin:8px 0"><select id="selTrackM" style="width:100%;height:40px"></select></div>
      <div style="display:flex;gap:8px;margin:8px 0">
        <input id="inpRoundsM" type="number" value="5" min="1" max="20" placeholder="Ronder" style="flex:1;height:40px;padding:0 8px">
        <input id="inpTimeM" type="number" value="60" min="10" max="240" placeholder="Sek/rond" style="flex:1;height:40px;padding:0 8px">
      </div>
      <div style="display:flex;gap:8px;margin:8px 0"><button class="btn" id="btnHostM">Skapa rum</button></div>
      <div style="display:flex;gap:8px;margin:8px 0"><input id="inpRoomM" placeholder="Rumskod" style="flex:1;height:40px;padding:0 8px"></div>
      <div style="display:flex;gap:8px;margin:8px 0">
        <input id="inpNameM" placeholder="Ditt namn" style="flex:1;height:40px;padding:0 8px">
        <button class="btn" id="btnJoinM">G√• med</button>
      </div>
      <div class="row" style="display:flex; gap:8px">
        <button class="btn" id="btnStartM" style="display:none">Starta</button>
      </div>
    </div>
  </section>

  <div class="bottbar mobile-only">
    <button class="btn" id="btnHint">Ledtr√•d</button>
    <button class="btn accent" id="btnGuess">L√•s gissning</button>
  </div>
</main>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ====== Helpers ====== */
const API_BASE = "https://fastfinder-dcnk.onrender.com"; // √§ndra vid behov
const api = (p) => (API_BASE || "") + p;
function wsURL(){
  if (API_BASE) return (API_BASE.startsWith("https") ? "wss://" : "ws://") + new URL(API_BASE).host + "/ws";
  return (location.protocol==='https:'?'wss':'ws')+'://'+location.host+'/ws';
}
const $ = id => document.getElementById(id);
function showErr(msg){ const e=$('err'); e.textContent=msg; e.style.display='block'; setTimeout(()=>e.style.display='none', 6000); }

/* ====== Karta ====== */
let map, youMarker=null, targetMarker=null;
try{
  map = L.map('map', { zoomControl:false }).setView([59.334, 18.0667], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'¬© OpenStreetMap'}).addTo(map);
  window.addEventListener('load', ()=> setTimeout(()=> map.invalidateSize(), 50));
}catch(e){ showErr('Kunde inte initiera kartan: '+e.message); }

/* ====== Scoreboard ====== */
function setBoard(tbodyEl, items){
  tbodyEl.innerHTML = "";
  (items||[]).forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.name}</td><td style="text-align:right">${r.score_total}</td>`;
    tbodyEl.appendChild(tr);
  });
}

/* ====== Tracks ====== */
function uniqueOrderedTracks(js){
  if(!js || !Array.isArray(js.tracks)) return [];
  const prefer = ["Stockholm","Malm√∂","G√∂teborg"];
  const set = new Map();
  js.tracks.forEach(t=>{ if(t) set.set(String(t).toLowerCase(), t); });
  const arr = [...set.values()];
  const first = prefer.filter(p=> arr.includes(p));
  const rest = arr.filter(x=> !first.includes(x)).sort();
  return [...first, ...rest];
}
async function loadTracks(){
  try{
    const r = await fetch(api('/api/tracks'));
    if(!r.ok) throw new Error(`tracks ${r.status}`);
    const js = await r.json();
    const tracks = uniqueOrderedTracks(js);
    if(!tracks.length){ showErr('Inga banor hittades. Har du lagt CSV i /data?'); return; }
    const sel = $("selTrack"); sel.innerHTML="";
    tracks.forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=`${t} (${js.counts?.[t] ?? "?"})`; sel.appendChild(o); });
    const selM = $("selTrackM"); selM.innerHTML="";
    tracks.forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=`${t} (${js.counts?.[t] ?? "?"})`; selM.appendChild(o); });
  }catch(e){ showErr('Kunde inte ladda banor: '+e.message); }
}
loadTracks();

/* ====== Host-hantering (utan att visa token) ====== */
let ws = null, roomId = null, hostToken = null, timer = null;
const LS_KEY = (rid) => `ff_host_token_${rid}`;

function updateHostUI(){
  const isHost = !!hostToken && !!roomId;
  const s1 = $('btnStart'), s2 = $('btnStartM');
  if (s1) s1.style.display = isHost ? 'inline-block' : 'none';
  if (s2) s2.style.display = isHost ? 'inline-block' : 'none';
}

/* ====== Kartklick = gissning ====== */
map.on('click', e=>{
  if(!ws){ return alert('Anslut ett rum f√∂rst.'); }
  if(youMarker) map.removeLayer(youMarker);
  youMarker = L.marker(e.latlng).addTo(map).bindPopup('Din gissning').openPopup();
});

/* ====== Timer ====== */
function startTimer(sec){
  $('hudTimer').textContent = sec + ' s';
  clearInterval(timer);
  timer = setInterval(()=>{ sec=Math.max(0,sec-1); $('hudTimer').textContent = sec+' s'; if(sec===0) clearInterval(timer); }, 1000);
}

/* ====== Skapa rum (desktop/mobil) ====== */
$('btnHost').onclick = async ()=>{
  try{
    const track = $('selTrack').value, rounds=+$('inpRounds').value, tl=+$('inpTime').value;
    const r = await fetch(api('/api/room'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({track, rounds, time_limit:tl})});
    if(!r.ok) throw new Error(await r.text());
    const js = await r.json();
    roomId = js.room_id; hostToken = js.host_token;
    localStorage.setItem(LS_KEY(roomId), hostToken);
    $('inpRoom').value = roomId;
    alert(`Rum skapat: ${roomId}`);
    updateHostUI();
  }catch(e){ showErr('Skapa rum: '+e.message); }
};
$('btnHostM').onclick = async ()=>{
  try{
    const track = $('selTrackM').value, rounds=+$('inpRoundsM').value, tl=+$('inpTimeM').value;
    const r = await fetch(api('/api/room'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({track, rounds, time_limit:tl})});
    if(!r.ok) throw new Error(await r.text());
    const js = await r.json();
    roomId = js.room_id; hostToken = js.host_token;
    localStorage.setItem(LS_KEY(roomId), hostToken);
    $('inpRoomM').value = roomId;
    alert(`Rum skapat: ${roomId}`);
    updateHostUI();
  }catch(e){ showErr('Skapa rum: '+e.message); }
};

/* ====== Join (desktop/mobil) ====== */
$('btnJoin').onclick = ()=> joinRoom($('inpRoom').value.trim(), ($('inpName').value||'Spelare').trim());
$('btnJoinM').onclick = ()=> joinRoom($('inpRoomM').value.trim(), ($('inpNameM').value||'Spelare').trim());

function joinRoom(rid, nm){
  if(!rid) return showErr('Ange rumskod.');
  roomId = rid;
  // Om den h√§r webbl√§saren skapade rummet tidigare ‚Äì h√§mta token
  hostToken = localStorage.getItem(LS_KEY(roomId)) || null;
  updateHostUI();

  ws = new WebSocket(wsURL());
  ws.onopen    = ()=> ws.send(JSON.stringify({type:"join", room_id: rid, name: nm}));
  ws.onmessage = ev => onWS(JSON.parse(ev.data));
  ws.onerror   = ()=> showErr('WebSocket-fel (kolla Console).');
}

/* ====== Start (endast host visas) ====== */
$('btnStart').onclick  = ()=> startGame();
$('btnStartM').onclick = ()=> startGame();
function startGame(){
  if(!ws) return showErr('Anslut f√∂rst.');
  if(!hostToken) return showErr('Endast v√§rden kan starta.');
  ws.send(JSON.stringify({type:"start", host_token: hostToken}));
}

/* ====== WS-h√§ndelser ====== */
function onWS(msg){
  if(msg.type==="room_state"){
    setBoard($('board').querySelector('tbody'), msg.players);
  } else if(msg.type==="round_start"){
    $('hudRound').textContent = `Rond ${msg.round_index+1}`;
    startTimer(msg.time_limit);
    if(targetMarker){ map.removeLayer(targetMarker); targetMarker=null; }
    if(youMarker){ map.removeLayer(youMarker); youMarker=null; }
  } else if(msg.type==="guess_result"){
    clearInterval(timer);
    if(targetMarker) map.removeLayer(targetMarker);
    targetMarker = L.circleMarker([msg.target.lat, msg.target.lon], {radius:8}).addTo(map).bindPopup('R√§tt plats');
    map.panTo([msg.target.lat, msg.target.lon]);
    setBoard($('board').querySelector('tbody'), msg.leaderboard);
  } else if(msg.type==="game_over"){
    clearInterval(timer);
    setBoard($('board').querySelector('tbody'), msg.leaderboard);
    alert('Spelet √§r slut! üéâ');
  } else if(msg.type==="error"){
    showErr(msg.error);
  }
}

/* ====== UI toggles ====== */
function openPanel(){ $('sidePanel').style.display='block' }
function closePanel(){ $('sidePanel').style.display='none' }
function openSheet(){ $('mSheet').classList.add('open') }
function closeSheet(){ $('mSheet').classList.remove('open') }
</script>
</body>
</html>
